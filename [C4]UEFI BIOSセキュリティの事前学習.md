事前学習
========

前提
-----
- 4時間の講義で理解できる技術内容は薄い
- 4時間の対話的セッションは技術内容の学習に適さないフォーマット
- 4時間のセッションだけでは受講生間のネットワークの構築の助けにならない
- 事"後"学習では、その後で生徒間や生徒講師間のコミュニケーションを取れない可能性が高い

事前学習の目的
--------------
- 本人が望むだけ時間を取り学習できるようにする
- グループワークを通して参加者間のネットワーク構築の助けとする
- 4時間のセッションを、事前学習のフォローアップに充て、技術的理解をさらに深める場とする

事前学習の目標ではないこと
------------------------
- 講義に向けて全員のレベルを一定まで上げる事
    - 事前学習は、学習意欲と時間のある人が望むだけ学習できる題材を提供する
- 講義の内容を自習で振り替える事
    - そもそも講義では十分な学習はできない。十分な理解を求めるのであれば事前事後学習が初めから必須
- 事前学習課題に対する正答を得る事
    - 事前学習は自己学習の機会である

進め方
------
- 講師が3～5名程度からなるグループを作成し通知する
- グループは話し合い、グループ内でどのように進めるか決めるが、最終的な成果物はグループとしてまとめる
- Slack等での講師へ質問は推奨する
- 題材はすべて実例のためインターネットで情報が見つかる。必要に応じて情報収集すること
- 回答の提出は不要。ただし講義で、ごく簡単な説明を各グループに求める場合がある
- すべての課題に回答できることは期待されてない（もしできたら、あなたはこの講義を受講する意味があまりない）
- 興味のあるトピックに集中してもよい
- 課題はどの順序で取り組んでもよい（ただし課題２のソフトウェアセットアップは課題３，４でも必要）
- 参照されている書籍を読む必要はない（座学的な要素は講義で扱う）。主に事後学習の参考のため示した

事前要件
--------
- ホスト：x64 Ubuntu、またはWindows+WSL、またはmacOS（だだしmacOSでは課題１のビルドはできない）
- 仮想マシン：x64 WindowsまたはLinuxの仮想マシン（課題１のみ）
    - Windows 10のISOは[Windows 10 のダウンロード](https://www.microsoft.com/ja-jp/software-download/windows10)から直接ダウンロード、もしくはメディア作成ツールを経由して作成できる
- 英語情報を調べる気合

書籍内の関連セクション
---------------------
- Introduction to Firmware (p.3)


課題１：ゲームチートに用いられるサードパーティー製UEFIモジュールの分析
=================================================================

タグ
-----
アーキテクチャ（Runtime Driver）、ソースコード

目標
-----
- gnu-efi版サードパーティー製UEFIモジュールのソース、ビルドおよび実行手順を大まかに理解する
    - ソースコードの理解はリバースエンジニアリングの演習に役立つ
- 一時話題を集めたUEFIベースのチート技術について、ゲームセキュリティと一般セキュリティ両方の観点から脅威モデルと影響を理解する

概要
-----
UEFI BIOSはOEMが出荷するモジュール群とは別に、サードパーティー製の独立したモジュールを扱う機能がある。これにより、例えば、デバイス所有者が独自のモジュールをビルドし、USBトライブからUEFI Shellを通して実行できる。このようなモジュールは、その技術的障壁の低さや特長により、2019年頃よりハッカーコミュニティーで広く使われ始め、ゲームチートにも利用されてきた。

[CRZEFI](https://github.com/rasyidabdulhalim/CRZAIMBOT)はそのようなモジュールをApex Legendsというオンラインゲームのチート用にカスタマイズしたものである。

指示
----
1. UEFIモジュールであるCRZEFIをビルドし、手順に従い仮想マシン内で実行しなさい
    - VMware Fusion/Workstation Proをインストールし、x64 WindowsまたはLinuxの仮想マシンを作成する
        - OSのインストールを開始する前に、VMの構成がUEFIベースである事を確認する
        - Virtual BoxとQEMUは未テストだが使用可能なはず
    - 手順メモ
    ```
    $ sudo apt update
    $ sudo apt install gnu-efi
    $ git clone https://github.com/rasyidabdulhalim/CRZAIMBOT.git
    $ cd CRZAIMBOT/CRZEFI/
    $ git checkout cd04d44a3fdfe38c83c38b96dbb14e810471f8aa
    $ make
    ...
    objcopy -j .text -j .sdata -j .data -j .dynamic \
        -j .dynsym  -j .rel -j .rela -j .reloc \
        --target=efi-rtdrv-x86_64 memory.so memory.efi
    $ ls
    Makefile  definitions.h  dummy.h  main.c  main.o  memory.efi  memory.so
    ```
    その後、`How To Load Memory.efi`の手順に従い仮想マシン内で実行しなさい
2. CRZEFIの機能概要を説明しなさい
3. CRZEFIの手法がゲームセキュリティに与える影響について考察しなさい。例えば、なぜチート開発者はUEFIモジュールを使うのか考察しなさい
4. CRZEFIへの潜在的な対策方法や対策技術を調査、考察しなさい。例えば、防止方法、検出方法、それらの利点と欠点を考察しなさい
5. CRZEFIの手法がマルウェアにも用いられるか否か、用いられる場合、どのような利用（攻撃）シナリオや制限等があるか考察しなさい


課題２：マルウェアが用いるUEFIモジュールの解析
===========================================

タグ
----
マルウェア

目標
-----
- UEFIモジュールの静的解析ツールと方法に親しむ
- 実際のUEFIマルウェアがどのようなものか知る

概要
-----
ここ数年、攻撃者はOSより下のレイヤー、とりわけUEFI BIOSを狙う傾向がある。この理由には、OS以上のレイヤーのセキュリティが向上し、より攻撃しやすい対象に移行していることに加え、UEFI BIOSへの攻撃が成功した場合に攻撃者が得られるメリットが大きいという側面もある。例えば、UEFI BIOSにマルウェアコードをインストールできた場合、攻撃者は次の機能を得ることができる。
1. OS再インストール後でも維持される常駐能力
2. セキュリティソフトに監視、削除されないコード実行能力
3. OSやハイパーバイザーレベルのセキュリティを部分的にバイパスする能力

MosaicRegressorは2020年に報告されたマルウェアで、UEFIモジュールを用いて上記の(1)と(2)を達成している。

指示
-----
1. UEFI BIOSモジュールの静的解析環境を構築しなさい
    - Ghidra + efiSeek（無料）
    - IDA Pro + efiXplorer（有料）または
    - Binary Ninja + bn-uefi-helper（有料）
2. SmmInterfaceBaseとSmmAccessSubモジュールを静的解析し、その実装を[解析情報](https://securelist.com/mosaicregressor/98849/)と比較しなさい
    - 多くのAPIは[EDK2レポジトリー](https://github.com/tianocore/edk2)または[UEFI仕様書](https://uefi.org/sites/default/files/resources/UEFI_Spec_2_9_2021_03_18.pdf)から見つけることができる

添付ファイル
------------

| ファイル          | SHA256                                                           |
|------------------|------------------------------------------------------------------|
| SmmInterfaceBase | c7c3e039700bc6072f84ff99ecb22557e460dcd2214539938a6a0ef73b9caa88 |
| SmmAccessSub     | b73df2299f1b61629d40e1896efdf170a6c6b44e3fd3f833fad081fcf08a3cbd |
| SmmReset         | 29759388b83c2141bdc224ce1ba348fe3778ffec86b2716bcd6eacc839363737 |
| Ntfs             | dfcdcabd576d8717dcc570a2820947e385f0e10bdb2d9a332e7a5823ea51b3ac |


課題３：脆弱なSMMモジュールの解析
===============================

タグ
----
アーキテクチャ（Firmware File System, System Management Mode）、アタックサーフェイス、脆弱性

目標
-----
- SMMについて、UEFI BIOSに潜むアタックサーフェイスという観点から学習する
- 脆弱なUEFI BIOSのセキュリティに対する潜在的な影響度を理解する
- 脆弱なUEFI BIOSの脅威を緩和する方法を議論する

概要
-----
UEFI BIOSモジュール群の一部はSystem Management Mode（SMM）と呼ばれる、OSやハイパーバイザーよりも高い権限で動作する。SMMモジュールは、System Management Interrupt（SMI）を通してOSから呼び出され、対応するSMIハンドラーを実行する。SMIハンドラーは、低い権限（OS）がコントロールできるあらゆる入力について安全に検査、対応する必要があるが、SMMモジュールの開発者（OEMとBIOSベンダー）は歴史的にこれに失敗してきている。そのような場合の結果これらのモジュールにSMMでの任意コードが実行可能な脆弱性があると、攻撃者は例えば次のことができるようになる。
1. UEFI BIOSの書き換えによる、OS再インストール後でも維持される常駐
2. OS、ハイパーバイザー、デバッガー等から不可視の領域でのコード実行
3. OSやハイパーバイザーレベルのセキュリティ機能の完全なバイパス

添付のファイルは、そのような脆弱性のあるSMMモジュールを含むUEFI BIOSイメージである。本モジュールの脆弱性（CVE-2021-26943）は、高い権限（SMM）で動作するSMIハンドラーが、低い権限（Ring 0）がコントロールできる値を十分に検証せずに使用することによって、SMM権限での任意アドレスの書き換えができるというものである。

指示
-----
1. [UEFITool](https://github.com/LongSoft/UEFITool)を用い、UEFI BIOSイメージから`NvmeSmm`SMMモジュールを見つなさい。次に、その`PE32　image section`をファイルとして取り出し、SHA256の値が`A9C762B13FC9C4156603D674C6DAEBC4369520D95ACB1D0FA976078D6F7F1003`であることを確認しなさい。
2. ファイルを静的解析しSMI 0x42のハンドラーを特定しなさい
3. SMIハンドラーのなかで、低い権限からの入力値の検証と対応が安全でない処理、理由を特定しなさい（ie, 脆弱性を発見し説明しなさい）
    - サブコマンドの実装は読む必要がない。問題個所はそれ以前のコード
4. 脆弱性の攻撃方法と悪用方法（影響）について考察しなさい
5. まったく同じ（脆弱性がある既知の）SMMモジュール使用したUEFI BIOSをどのように発見できるか考察しなさい
    - SMMモジュール開発者、セキュリティ研究者、組織のIT管理者、その他、いずれの視点でも良い
6. 類似の脆弱性がある（未知の）SMMモジュールをどのように発見できるか考察しなさい。
    - 同上

添付ファイル
------------

| ファイル        | SHA256                                                           |
|----------------|------------------------------------------------------------------|
| UX360CA-AS.303 | A2288B225C9C5B3D0FC524CB6DA9A6131EB29A8A73D1FC528F4822841FDC34B9 |
| NvmeSmm        | A9C762B13FC9C4156603D674C6DAEBC4369520D95ACB1D0FA976078D6F7F1003 |

書籍内の関連セクション
---------------------
- X86 SMM (p.681)


課題４：WindowsからUEFI BIOSに感染するマルウェアの解析
====================================================

タグ
----
アーキテクチャ（セキュリティ）、アタックサーフェイス、脆弱性、マルウェア

目標
-----
- Intelプラットフォームにおいて、UEFI BIOSがどのように不正な書き換えから保護されているか学習する
- 保護が適切に設定されていない場合の影響を、UEFI BIOSに感染するマルウェアの解析を通して理解する

概要
-----
BIOSはSPIフラッシュと呼ばれる、ハードディスクやSDDとは異なるデバイスに内容が保存されており、システムは、起動時にその内容を読み取り実行を開始する。BIOSには高い権限で実行されるSMMモジュールや、Secure Bootなどのセキュリティ機能の実装が含まれており、セキュリティ上、非常に機微である。そのためプラットフォーム（とりわけサウスブリッジ）には、SMM以外からのSPIフラッシュの書き換えを禁止できるレジスターが用意されており、OEMが出荷するUEFI BIOSコードは、OSが起動する前にそれらを有効にしてSPIフラッシュを保護する必要がある。しかしながら、歴史的に多くのOEMとBIOSベンダーがこれを行わないデバイスを出荷しており、SPIフラッシュがOSやハイパーバイザーから書き込み可能な場合がある。

2018年に発見された[Lojax](https://www.welivesecurity.com/2018/09/27/lojax-first-uefi-rootkit-found-wild-courtesy-sednit-group/)はこのような脆弱性を悪用し、カーネルモードからUEFI BIOSを書き換え、悪意のモジュールを挿入するマルウェアである。

指示
-----
1. Lojaxについて調べなさい
    1. Lojaxがチェックする、BIOSの書き込み保護に関連した以下の３ビットの機能を[Intel 9 Series PCHの仕様書](https://www.intel.com/content/www/us/en/products/docs/chipsets/9-series-chipset-pch-datasheet.html)を引用しながら説明しなさい
        - BIOSWE
        - BLE
        - SMM_BWP
    2. ReWriter_binary.exeを静的解析し、その機能を上記３ビットと関連付けて簡単に説明しなさい
2. Lojaxが悪用する脆弱性があるデバイスやUEFI BIOSをどのように発見、対処できるか考察しなさい
3. 同脆弱性を悪用するマルウェアをどのように一般化して発見、対処できるか考察しなさい

添付ファイル
------------

| ファイル         | SHA256                                                           |
|-----------------|------------------------------------------------------------------|
| ReWriter_binary | fc28ad61fc748c08e8714cb247e741b736ebf0d9dfbcc3579f66fe3168326f61 |
| SecDxe          | 7ea33696c91761e95697549e0b0f84db2cf4033216cd16c3264b10daa31f598c |

- ReWriter_binaryはWindows実行可能ファイル。実機で実行しないこと。
    - 意図しない実行への防止策としてMZヘッダーを変更している。

書籍内の関連セクション
---------------------
- BIOS Write Protection (p.745)
- Race Condition Attack (p.107)
- Race Condition Attack Prevention (p.698)